/**
 * Environment file generator for Scanner Map
 * Generates .env files based on user selections
 */

const fs = require('fs-extra');
const path = require('path');

class EnvGenerator {
  constructor(projectRoot) {
    this.projectRoot = projectRoot;
    this.envPath = path.join(projectRoot, '.env');
  }

  /**
   * Generate .env file based on configuration
   */
  async generate(config) {
    const {
      // Core settings
      webserverPort = 3001,
      botPort = 3306,
      publicDomain = 'localhost',
      timezone = 'America/New_York',
      
      // Discord
      enableDiscord = false,
      discordToken = '',
      clientId = '',
      
      // Transcription
      transcriptionMode = 'local',
      transcriptionDevice = 'cpu',
      
      // AI Provider
      aiProvider = 'openai',
      openaiApiKey = '',
      openaiModel = 'gpt-4o-mini',
      ollamaUrl = 'http://ollama:11434',
      ollamaModel = 'llama3.1:8b',
      
      // Geocoding
      geocodingProvider = 'nominatim',
      googleMapsApiKey = '',
      locationiqApiKey = '',
      geocodingState = 'MD',
      geocodingCountry = 'us',
      geocodingCity = 'Baltimore',
      geocodingTargetCounties = 'Baltimore,Baltimore City,Anne Arundel',
      
      // Storage
      storageMode = 'local',
      
      // Authentication
      enableAuth = false,
      webserverPassword = '',
      sessionDurationDays = 7,
      maxSessionsPerUser = 5,
      
      // Talk Groups
      mappedTalkGroups = '',
      enableMappedTalkGroups = true,
      
      // iCAD
      enableICAD = false,
      icadUrl = 'http://icad-transcribe:9912',
      icadProfile = 'whisper-1',
      icadApiKey = 'AUTO_GENERATE_ON_STARTUP',
      
      // TrunkRecorder API key (auto-generated)
      trunkRecorderApiKey = null,
      
      // Installation type
      installationType = 'docker' // 'docker' or 'local'
    } = config;

    // Adjust URLs for local installation
    const finalOllamaUrl = installationType === 'local' 
      ? (ollamaUrl.replace('ollama:', 'localhost:') || 'http://localhost:11434')
      : ollamaUrl;
    
    const finalICADUrl = installationType === 'local'
      ? (icadUrl.replace('icad-transcribe:', 'localhost:') || 'http://localhost:9912')
      : icadUrl;

    let envContent = `# Scanner Map Configuration
# Generated by installer on ${new Date().toISOString()}
# Installation Type: ${installationType}

# --- Core Settings ---
WEBSERVER_PORT=${webserverPort}
BOT_PORT=${botPort}
PUBLIC_DOMAIN=${publicDomain}
TIMEZONE=${timezone}

# --- Discord Bot (Optional) ---
ENABLE_DISCORD=${enableDiscord}
DISCORD_TOKEN=${discordToken}
CLIENT_ID=${clientId}

# --- Transcription Mode ---
# Options: local, remote, openai, icad
TRANSCRIPTION_MODE=${transcriptionMode}
TRANSCRIPTION_DEVICE=${transcriptionDevice}

# --- AI Provider ---
# Options: openai, ollama
AI_PROVIDER=${aiProvider}
`;

    // Add AI provider specific config
    if (aiProvider === 'openai') {
      envContent += `OPENAI_API_KEY=${openaiApiKey}
OPENAI_MODEL=${openaiModel}
`;
      if (enableICAD || ollamaUrl) {
        envContent += `# Ollama settings (not used with OpenAI)
# OLLAMA_URL=${finalOllamaUrl}
# OLLAMA_MODEL=${ollamaModel}
`;
      }
    } else if (aiProvider === 'ollama') {
      envContent += `OLLAMA_URL=${finalOllamaUrl}
OLLAMA_MODEL=${ollamaModel}
`;
      envContent += `# OpenAI settings (not used with Ollama)
# OPENAI_API_KEY=
# OPENAI_MODEL=${openaiModel}
`;
    }

    // Add iCAD config if enabled
    if (enableICAD) {
      // Use provided API key or placeholder
      const finalICADApiKey = icadApiKey && icadApiKey !== 'AUTO_GENERATE_ON_STARTUP' 
        ? icadApiKey 
        : (icadApiKey || '');
      envContent += `
# --- iCAD Transcribe Settings (if TRANSCRIPTION_MODE=icad) ---
ICAD_URL=${finalICADUrl}
ICAD_PROFILE=${icadProfile}
# API key auto-generated during installation
ICAD_API_KEY=${finalICADApiKey}
`;
    } else {
      envContent += `
# --- iCAD Transcribe Settings (not configured) ---
# ICAD_URL=http://localhost:9912
# ICAD_PROFILE=whisper-1
# ICAD_API_KEY=
`;
    }

    // Add TrunkRecorder API key if provided
    if (trunkRecorderApiKey) {
      envContent += `
# --- TrunkRecorder API Key (auto-generated) ---
TRUNKRECORDER_API_KEY=${trunkRecorderApiKey}
`;
    }

    // Add geocoding config
    envContent += `
# --- Geocoding ---
# Provider: nominatim (free, no API key), locationiq (free tier), or google (paid)
GEOCODING_PROVIDER=${geocodingProvider}
GOOGLE_MAPS_API_KEY=${googleMapsApiKey}
LOCATIONIQ_API_KEY=${locationiqApiKey}
GEOCODING_STATE=${geocodingState}
GEOCODING_COUNTRY=${geocodingCountry}
GEOCODING_CITY=${geocodingCity}
GEOCODING_TARGET_COUNTIES=${geocodingTargetCounties}

# --- Storage ---
STORAGE_MODE=${storageMode}
# S3 settings (if STORAGE_MODE=s3)
# S3_ENDPOINT=
# S3_BUCKET_NAME=
# S3_ACCESS_KEY_ID=
# S3_SECRET_ACCESS_KEY=

# --- Authentication ---
ENABLE_AUTH=${enableAuth}
WEBSERVER_PASSWORD=${webserverPassword}
SESSION_DURATION_DAYS=${sessionDurationDays}
MAX_SESSIONS_PER_USER=${maxSessionsPerUser}

# --- Talk Groups ---
MAPPED_TALK_GROUPS=${mappedTalkGroups}
ENABLE_MAPPED_TALK_GROUPS=${enableMappedTalkGroups}
`;

    // Write .env file
    await fs.ensureDir(path.dirname(this.envPath));
    await fs.writeFile(this.envPath, envContent, 'utf8');
    
    return this.envPath;
  }

  /**
   * Check if .env already exists
   */
  async exists() {
    return await fs.pathExists(this.envPath);
  }

  /**
   * Backup existing .env file
   */
  async backup() {
    if (await this.exists()) {
      const backupPath = `${this.envPath}.backup.${Date.now()}`;
      await fs.copy(this.envPath, backupPath);
      return backupPath;
    }
    return null;
  }
}

module.exports = EnvGenerator;


 * Generates .env files based on user selections
 */

const fs = require('fs-extra');
const path = require('path');

class EnvGenerator {
  constructor(projectRoot) {
    this.projectRoot = projectRoot;
    this.envPath = path.join(projectRoot, '.env');
  }

  /**
   * Generate .env file based on configuration
   */
  async generate(config) {
    const {
      // Core settings
      webserverPort = 3001,
      botPort = 3306,
      publicDomain = 'localhost',
      timezone = 'America/New_York',
      
      // Discord
      enableDiscord = false,
      discordToken = '',
      clientId = '',
      
      // Transcription
      transcriptionMode = 'local',
      transcriptionDevice = 'cpu',
      
      // AI Provider
      aiProvider = 'openai',
      openaiApiKey = '',
      openaiModel = 'gpt-4o-mini',
      ollamaUrl = 'http://ollama:11434',
      ollamaModel = 'llama3.1:8b',
      
      // Geocoding
      geocodingProvider = 'nominatim',
      googleMapsApiKey = '',
      locationiqApiKey = '',
      geocodingState = 'MD',
      geocodingCountry = 'us',
      geocodingCity = 'Baltimore',
      geocodingTargetCounties = 'Baltimore,Baltimore City,Anne Arundel',
      
      // Storage
      storageMode = 'local',
      
      // Authentication
      enableAuth = false,
      webserverPassword = '',
      sessionDurationDays = 7,
      maxSessionsPerUser = 5,
      
      // Talk Groups
      mappedTalkGroups = '',
      enableMappedTalkGroups = true,
      
      // iCAD
      enableICAD = false,
      icadUrl = 'http://icad-transcribe:9912',
      icadProfile = 'whisper-1',
      icadApiKey = 'AUTO_GENERATE_ON_STARTUP',
      
      // TrunkRecorder API key (auto-generated)
      trunkRecorderApiKey = null,
      
      // Installation type
      installationType = 'docker' // 'docker' or 'local'
    } = config;

    // Adjust URLs for local installation
    const finalOllamaUrl = installationType === 'local' 
      ? (ollamaUrl.replace('ollama:', 'localhost:') || 'http://localhost:11434')
      : ollamaUrl;
    
    const finalICADUrl = installationType === 'local'
      ? (icadUrl.replace('icad-transcribe:', 'localhost:') || 'http://localhost:9912')
      : icadUrl;

    let envContent = `# Scanner Map Configuration
# Generated by installer on ${new Date().toISOString()}
# Installation Type: ${installationType}

# --- Core Settings ---
WEBSERVER_PORT=${webserverPort}
BOT_PORT=${botPort}
PUBLIC_DOMAIN=${publicDomain}
TIMEZONE=${timezone}

# --- Discord Bot (Optional) ---
ENABLE_DISCORD=${enableDiscord}
DISCORD_TOKEN=${discordToken}
CLIENT_ID=${clientId}

# --- Transcription Mode ---
# Options: local, remote, openai, icad
TRANSCRIPTION_MODE=${transcriptionMode}
TRANSCRIPTION_DEVICE=${transcriptionDevice}

# --- AI Provider ---
# Options: openai, ollama
AI_PROVIDER=${aiProvider}
`;

    // Add AI provider specific config
    if (aiProvider === 'openai') {
      envContent += `OPENAI_API_KEY=${openaiApiKey}
OPENAI_MODEL=${openaiModel}
`;
      if (enableICAD || ollamaUrl) {
        envContent += `# Ollama settings (not used with OpenAI)
# OLLAMA_URL=${finalOllamaUrl}
# OLLAMA_MODEL=${ollamaModel}
`;
      }
    } else if (aiProvider === 'ollama') {
      envContent += `OLLAMA_URL=${finalOllamaUrl}
OLLAMA_MODEL=${ollamaModel}
`;
      envContent += `# OpenAI settings (not used with Ollama)
# OPENAI_API_KEY=
# OPENAI_MODEL=${openaiModel}
`;
    }

    // Add iCAD config if enabled
    if (enableICAD) {
      // Use provided API key or placeholder
      const finalICADApiKey = icadApiKey && icadApiKey !== 'AUTO_GENERATE_ON_STARTUP' 
        ? icadApiKey 
        : (icadApiKey || '');
      envContent += `
# --- iCAD Transcribe Settings (if TRANSCRIPTION_MODE=icad) ---
ICAD_URL=${finalICADUrl}
ICAD_PROFILE=${icadProfile}
# API key auto-generated during installation
ICAD_API_KEY=${finalICADApiKey}
`;
    } else {
      envContent += `
# --- iCAD Transcribe Settings (not configured) ---
# ICAD_URL=http://localhost:9912
# ICAD_PROFILE=whisper-1
# ICAD_API_KEY=
`;
    }

    // Add TrunkRecorder API key if provided
    if (trunkRecorderApiKey) {
      envContent += `
# --- TrunkRecorder API Key (auto-generated) ---
TRUNKRECORDER_API_KEY=${trunkRecorderApiKey}
`;
    }

    // Add geocoding config
    envContent += `
# --- Geocoding ---
# Provider: nominatim (free, no API key), locationiq (free tier), or google (paid)
GEOCODING_PROVIDER=${geocodingProvider}
GOOGLE_MAPS_API_KEY=${googleMapsApiKey}
LOCATIONIQ_API_KEY=${locationiqApiKey}
GEOCODING_STATE=${geocodingState}
GEOCODING_COUNTRY=${geocodingCountry}
GEOCODING_CITY=${geocodingCity}
GEOCODING_TARGET_COUNTIES=${geocodingTargetCounties}

# --- Storage ---
STORAGE_MODE=${storageMode}
# S3 settings (if STORAGE_MODE=s3)
# S3_ENDPOINT=
# S3_BUCKET_NAME=
# S3_ACCESS_KEY_ID=
# S3_SECRET_ACCESS_KEY=

# --- Authentication ---
ENABLE_AUTH=${enableAuth}
WEBSERVER_PASSWORD=${webserverPassword}
SESSION_DURATION_DAYS=${sessionDurationDays}
MAX_SESSIONS_PER_USER=${maxSessionsPerUser}

# --- Talk Groups ---
MAPPED_TALK_GROUPS=${mappedTalkGroups}
ENABLE_MAPPED_TALK_GROUPS=${enableMappedTalkGroups}
`;

    // Write .env file
    await fs.ensureDir(path.dirname(this.envPath));
    await fs.writeFile(this.envPath, envContent, 'utf8');
    
    return this.envPath;
  }

  /**
   * Check if .env already exists
   */
  async exists() {
    return await fs.pathExists(this.envPath);
  }

  /**
   * Backup existing .env file
   */
  async backup() {
    if (await this.exists()) {
      const backupPath = `${this.envPath}.backup.${Date.now()}`;
      await fs.copy(this.envPath, backupPath);
      return backupPath;
    }
    return null;
  }
}

module.exports = EnvGenerator;


 * Generates .env files based on user selections
 */

const fs = require('fs-extra');
const path = require('path');

class EnvGenerator {
  constructor(projectRoot) {
    this.projectRoot = projectRoot;
    this.envPath = path.join(projectRoot, '.env');
  }

  /**
   * Generate .env file based on configuration
   */
  async generate(config) {
    const {
      // Core settings
      webserverPort = 3001,
      botPort = 3306,
      publicDomain = 'localhost',
      timezone = 'America/New_York',
      
      // Discord
      enableDiscord = false,
      discordToken = '',
      clientId = '',
      
      // Transcription
      transcriptionMode = 'local',
      transcriptionDevice = 'cpu',
      
      // AI Provider
      aiProvider = 'openai',
      openaiApiKey = '',
      openaiModel = 'gpt-4o-mini',
      ollamaUrl = 'http://ollama:11434',
      ollamaModel = 'llama3.1:8b',
      
      // Geocoding
      geocodingProvider = 'nominatim',
      googleMapsApiKey = '',
      locationiqApiKey = '',
      geocodingState = 'MD',
      geocodingCountry = 'us',
      geocodingCity = 'Baltimore',
      geocodingTargetCounties = 'Baltimore,Baltimore City,Anne Arundel',
      
      // Storage
      storageMode = 'local',
      
      // Authentication
      enableAuth = false,
      webserverPassword = '',
      sessionDurationDays = 7,
      maxSessionsPerUser = 5,
      
      // Talk Groups
      mappedTalkGroups = '',
      enableMappedTalkGroups = true,
      
      // iCAD
      enableICAD = false,
      icadUrl = 'http://icad-transcribe:9912',
      icadProfile = 'whisper-1',
      icadApiKey = 'AUTO_GENERATE_ON_STARTUP',
      
      // TrunkRecorder API key (auto-generated)
      trunkRecorderApiKey = null,
      
      // Installation type
      installationType = 'docker' // 'docker' or 'local'
    } = config;

    // Adjust URLs for local installation
    const finalOllamaUrl = installationType === 'local' 
      ? (ollamaUrl.replace('ollama:', 'localhost:') || 'http://localhost:11434')
      : ollamaUrl;
    
    const finalICADUrl = installationType === 'local'
      ? (icadUrl.replace('icad-transcribe:', 'localhost:') || 'http://localhost:9912')
      : icadUrl;

    let envContent = `# Scanner Map Configuration
# Generated by installer on ${new Date().toISOString()}
# Installation Type: ${installationType}

# --- Core Settings ---
WEBSERVER_PORT=${webserverPort}
BOT_PORT=${botPort}
PUBLIC_DOMAIN=${publicDomain}
TIMEZONE=${timezone}

# --- Discord Bot (Optional) ---
ENABLE_DISCORD=${enableDiscord}
DISCORD_TOKEN=${discordToken}
CLIENT_ID=${clientId}

# --- Transcription Mode ---
# Options: local, remote, openai, icad
TRANSCRIPTION_MODE=${transcriptionMode}
TRANSCRIPTION_DEVICE=${transcriptionDevice}

# --- AI Provider ---
# Options: openai, ollama
AI_PROVIDER=${aiProvider}
`;

    // Add AI provider specific config
    if (aiProvider === 'openai') {
      envContent += `OPENAI_API_KEY=${openaiApiKey}
OPENAI_MODEL=${openaiModel}
`;
      if (enableICAD || ollamaUrl) {
        envContent += `# Ollama settings (not used with OpenAI)
# OLLAMA_URL=${finalOllamaUrl}
# OLLAMA_MODEL=${ollamaModel}
`;
      }
    } else if (aiProvider === 'ollama') {
      envContent += `OLLAMA_URL=${finalOllamaUrl}
OLLAMA_MODEL=${ollamaModel}
`;
      envContent += `# OpenAI settings (not used with Ollama)
# OPENAI_API_KEY=
# OPENAI_MODEL=${openaiModel}
`;
    }

    // Add iCAD config if enabled
    if (enableICAD) {
      // Use provided API key or placeholder
      const finalICADApiKey = icadApiKey && icadApiKey !== 'AUTO_GENERATE_ON_STARTUP' 
        ? icadApiKey 
        : (icadApiKey || '');
      envContent += `
# --- iCAD Transcribe Settings (if TRANSCRIPTION_MODE=icad) ---
ICAD_URL=${finalICADUrl}
ICAD_PROFILE=${icadProfile}
# API key auto-generated during installation
ICAD_API_KEY=${finalICADApiKey}
`;
    } else {
      envContent += `
# --- iCAD Transcribe Settings (not configured) ---
# ICAD_URL=http://localhost:9912
# ICAD_PROFILE=whisper-1
# ICAD_API_KEY=
`;
    }

    // Add TrunkRecorder API key if provided
    if (trunkRecorderApiKey) {
      envContent += `
# --- TrunkRecorder API Key (auto-generated) ---
TRUNKRECORDER_API_KEY=${trunkRecorderApiKey}
`;
    }

    // Add geocoding config
    envContent += `
# --- Geocoding ---
# Provider: nominatim (free, no API key), locationiq (free tier), or google (paid)
GEOCODING_PROVIDER=${geocodingProvider}
GOOGLE_MAPS_API_KEY=${googleMapsApiKey}
LOCATIONIQ_API_KEY=${locationiqApiKey}
GEOCODING_STATE=${geocodingState}
GEOCODING_COUNTRY=${geocodingCountry}
GEOCODING_CITY=${geocodingCity}
GEOCODING_TARGET_COUNTIES=${geocodingTargetCounties}

# --- Storage ---
STORAGE_MODE=${storageMode}
# S3 settings (if STORAGE_MODE=s3)
# S3_ENDPOINT=
# S3_BUCKET_NAME=
# S3_ACCESS_KEY_ID=
# S3_SECRET_ACCESS_KEY=

# --- Authentication ---
ENABLE_AUTH=${enableAuth}
WEBSERVER_PASSWORD=${webserverPassword}
SESSION_DURATION_DAYS=${sessionDurationDays}
MAX_SESSIONS_PER_USER=${maxSessionsPerUser}

# --- Talk Groups ---
MAPPED_TALK_GROUPS=${mappedTalkGroups}
ENABLE_MAPPED_TALK_GROUPS=${enableMappedTalkGroups}
`;

    // Write .env file
    await fs.ensureDir(path.dirname(this.envPath));
    await fs.writeFile(this.envPath, envContent, 'utf8');
    
    return this.envPath;
  }

  /**
   * Check if .env already exists
   */
  async exists() {
    return await fs.pathExists(this.envPath);
  }

  /**
   * Backup existing .env file
   */
  async backup() {
    if (await this.exists()) {
      const backupPath = `${this.envPath}.backup.${Date.now()}`;
      await fs.copy(this.envPath, backupPath);
      return backupPath;
    }
    return null;
  }
}

module.exports = EnvGenerator;


 * Generates .env files based on user selections
 */

const fs = require('fs-extra');
const path = require('path');

class EnvGenerator {
  constructor(projectRoot) {
    this.projectRoot = projectRoot;
    this.envPath = path.join(projectRoot, '.env');
  }

  /**
   * Generate .env file based on configuration
   */
  async generate(config) {
    const {
      // Core settings
      webserverPort = 3001,
      botPort = 3306,
      publicDomain = 'localhost',
      timezone = 'America/New_York',
      
      // Discord
      enableDiscord = false,
      discordToken = '',
      clientId = '',
      
      // Transcription
      transcriptionMode = 'local',
      transcriptionDevice = 'cpu',
      
      // AI Provider
      aiProvider = 'openai',
      openaiApiKey = '',
      openaiModel = 'gpt-4o-mini',
      ollamaUrl = 'http://ollama:11434',
      ollamaModel = 'llama3.1:8b',
      
      // Geocoding
      geocodingProvider = 'nominatim',
      googleMapsApiKey = '',
      locationiqApiKey = '',
      geocodingState = 'MD',
      geocodingCountry = 'us',
      geocodingCity = 'Baltimore',
      geocodingTargetCounties = 'Baltimore,Baltimore City,Anne Arundel',
      
      // Storage
      storageMode = 'local',
      
      // Authentication
      enableAuth = false,
      webserverPassword = '',
      sessionDurationDays = 7,
      maxSessionsPerUser = 5,
      
      // Talk Groups
      mappedTalkGroups = '',
      enableMappedTalkGroups = true,
      
      // iCAD
      enableICAD = false,
      icadUrl = 'http://icad-transcribe:9912',
      icadProfile = 'whisper-1',
      icadApiKey = 'AUTO_GENERATE_ON_STARTUP',
      
      // TrunkRecorder API key (auto-generated)
      trunkRecorderApiKey = null,
      
      // Installation type
      installationType = 'docker' // 'docker' or 'local'
    } = config;

    // Adjust URLs for local installation
    const finalOllamaUrl = installationType === 'local' 
      ? (ollamaUrl.replace('ollama:', 'localhost:') || 'http://localhost:11434')
      : ollamaUrl;
    
    const finalICADUrl = installationType === 'local'
      ? (icadUrl.replace('icad-transcribe:', 'localhost:') || 'http://localhost:9912')
      : icadUrl;

    let envContent = `# Scanner Map Configuration
# Generated by installer on ${new Date().toISOString()}
# Installation Type: ${installationType}

# --- Core Settings ---
WEBSERVER_PORT=${webserverPort}
BOT_PORT=${botPort}
PUBLIC_DOMAIN=${publicDomain}
TIMEZONE=${timezone}

# --- Discord Bot (Optional) ---
ENABLE_DISCORD=${enableDiscord}
DISCORD_TOKEN=${discordToken}
CLIENT_ID=${clientId}

# --- Transcription Mode ---
# Options: local, remote, openai, icad
TRANSCRIPTION_MODE=${transcriptionMode}
TRANSCRIPTION_DEVICE=${transcriptionDevice}

# --- AI Provider ---
# Options: openai, ollama
AI_PROVIDER=${aiProvider}
`;

    // Add AI provider specific config
    if (aiProvider === 'openai') {
      envContent += `OPENAI_API_KEY=${openaiApiKey}
OPENAI_MODEL=${openaiModel}
`;
      if (enableICAD || ollamaUrl) {
        envContent += `# Ollama settings (not used with OpenAI)
# OLLAMA_URL=${finalOllamaUrl}
# OLLAMA_MODEL=${ollamaModel}
`;
      }
    } else if (aiProvider === 'ollama') {
      envContent += `OLLAMA_URL=${finalOllamaUrl}
OLLAMA_MODEL=${ollamaModel}
`;
      envContent += `# OpenAI settings (not used with Ollama)
# OPENAI_API_KEY=
# OPENAI_MODEL=${openaiModel}
`;
    }

    // Add iCAD config if enabled
    if (enableICAD) {
      // Use provided API key or placeholder
      const finalICADApiKey = icadApiKey && icadApiKey !== 'AUTO_GENERATE_ON_STARTUP' 
        ? icadApiKey 
        : (icadApiKey || '');
      envContent += `
# --- iCAD Transcribe Settings (if TRANSCRIPTION_MODE=icad) ---
ICAD_URL=${finalICADUrl}
ICAD_PROFILE=${icadProfile}
# API key auto-generated during installation
ICAD_API_KEY=${finalICADApiKey}
`;
    } else {
      envContent += `
# --- iCAD Transcribe Settings (not configured) ---
# ICAD_URL=http://localhost:9912
# ICAD_PROFILE=whisper-1
# ICAD_API_KEY=
`;
    }

    // Add TrunkRecorder API key if provided
    if (trunkRecorderApiKey) {
      envContent += `
# --- TrunkRecorder API Key (auto-generated) ---
TRUNKRECORDER_API_KEY=${trunkRecorderApiKey}
`;
    }

    // Add geocoding config
    envContent += `
# --- Geocoding ---
# Provider: nominatim (free, no API key), locationiq (free tier), or google (paid)
GEOCODING_PROVIDER=${geocodingProvider}
GOOGLE_MAPS_API_KEY=${googleMapsApiKey}
LOCATIONIQ_API_KEY=${locationiqApiKey}
GEOCODING_STATE=${geocodingState}
GEOCODING_COUNTRY=${geocodingCountry}
GEOCODING_CITY=${geocodingCity}
GEOCODING_TARGET_COUNTIES=${geocodingTargetCounties}

# --- Storage ---
STORAGE_MODE=${storageMode}
# S3 settings (if STORAGE_MODE=s3)
# S3_ENDPOINT=
# S3_BUCKET_NAME=
# S3_ACCESS_KEY_ID=
# S3_SECRET_ACCESS_KEY=

# --- Authentication ---
ENABLE_AUTH=${enableAuth}
WEBSERVER_PASSWORD=${webserverPassword}
SESSION_DURATION_DAYS=${sessionDurationDays}
MAX_SESSIONS_PER_USER=${maxSessionsPerUser}

# --- Talk Groups ---
MAPPED_TALK_GROUPS=${mappedTalkGroups}
ENABLE_MAPPED_TALK_GROUPS=${enableMappedTalkGroups}
`;

    // Write .env file
    await fs.ensureDir(path.dirname(this.envPath));
    await fs.writeFile(this.envPath, envContent, 'utf8');
    
    return this.envPath;
  }

  /**
   * Check if .env already exists
   */
  async exists() {
    return await fs.pathExists(this.envPath);
  }

  /**
   * Backup existing .env file
   */
  async backup() {
    if (await this.exists()) {
      const backupPath = `${this.envPath}.backup.${Date.now()}`;
      await fs.copy(this.envPath, backupPath);
      return backupPath;
    }
    return null;
  }
}

module.exports = EnvGenerator;

