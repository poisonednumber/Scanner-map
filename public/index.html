<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scanner Map</title>

  <!-- Leaflet Core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

  <!-- Other Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />

  <!-- Inline Styles -->
  <style>
    .center-controls {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .search-heatmap-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #search-input {
      flex: 1;
      min-width: 200px;
      max-width: 300px;
    }

    .heatmap-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
    }

    #heatmap-intensity-container {
      min-width: 100px;
      margin-left: 10px;
    }

    .sessions-list {
      max-height: 400px;
      overflow-y: auto;
      margin: 15px 0;
    }

    .session-item {
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--background-color);
    }

    .session-info {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .session-details {
      flex-grow: 1;
      padding-right: 15px;
    }

    .session-actions {
      display: flex;
      gap: 10px;
    }

    .terminate-session-btn {
      background-color: #330000;
      color: #ff0000;
      border: 1px solid #ff0000;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
      font-family: 'Share Tech Mono', monospace;
      transition: all 0.3s;
    }

    .terminate-session-btn:hover {
      background-color: #ff0000;
      color: var(--background-color);
      box-shadow: 0 0 10px #ff0000;
    }

    .current-session {
      border: 1px solid var(--primary-color);
      box-shadow: 0 0 5px var(--primary-color);
    }

    .device-info {
      margin-top: 8px;
      font-size: 0.9em;
      opacity: 0.8;
    }

    .user-selection {
      margin-bottom: 15px;
    }

    .user-selection label {
      margin-right: 10px;
      font-weight: bold;
    }

    @media screen and (max-width: 768px) {
      .search-heatmap-container {
        flex-direction: column;
        width: 100%;
        align-items: stretch;
      }

      #search-input {
        width: 100%;
        max-width: none;
        margin-bottom: 10px;
      }

      .heatmap-controls {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      #heatmap-intensity-container {
        width: 100%;
        margin-left: 0;
        margin-top: 5px;
      }

      .session-info {
        flex-direction: column;
      }

      .session-actions {
        margin-top: 10px;
        width: 100%;
        justify-content: flex-end;
      }

      .session-details {
        padding-right: 0;
      }
    }

    /* Styles for Global Volume Control */
    .global-volume-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px; /* Add space below heatmap controls */
      width: 100%; /* Take full width in its container */
      justify-content: center; /* Center items */
    }

    .global-volume-controls label {
      font-size: 14px;
      color: var(--text-color);
      white-space: nowrap;
    }

    #global-volume {
      width: 100%;
      max-width: 200px; /* Limit slider width */
      height: 8px;
    }

    /* Adjust global volume layout for mobile */
    .global-volume-controls {
      margin-top: 5px;
      padding: 0 5px; /* Add padding */
    }
    .global-volume-controls label {
      font-size: 12px; /* Smaller label */
    }
    #global-volume {
      max-width: 150px; /* Shorter slider on mobile */
    }

    /* --- Live Feed Display Styles --- */
    #live-feed-display {
      position: fixed;
      bottom: 200px; /* Adjust based on control panel height, especially mobile */
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 500px;
      max-height: 150px; /* Approx 5 lines */
      background-color: rgba(0, 0, 0, 0.85);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
      z-index: 997; /* Below control panel/modals, above map */
      overflow: hidden; /* Prevent scrollbars */
      display: flex;
      flex-direction: column-reverse; /* Newest items appear at the bottom and push upwards */
      padding: 5px;
      box-sizing: border-box;
      pointer-events: none; /* Allow clicks to pass through to map */
      transition: bottom 0.3s ease-in-out; /* For mobile positioning */
    }

    .live-feed-item {
      padding: 4px 8px;
      margin-bottom: 3px; /* Space between items */
      font-family: 'Share Tech Mono', monospace;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      background-color: rgba(0, 20, 0, 0.7); /* Slight background */
      border-radius: 3px;
      opacity: 1;
      transition: opacity 1.5s ease-out; /* Slower fade out */
      border-left: 2px solid var(--primary-color); /* Indicator */
    }

    .live-feed-item.fading-out {
      opacity: 0;
    }

    .live-feed-item strong {
        color: #00ccff; /* Highlight talkgroup name */
        margin-right: 5px;
    }

    /* Mobile adjustment for live feed display position */
    @media screen and (max-width: 768px) {
        #live-feed-display {
            bottom: 190px; /* Position above the taller mobile control panel */
            max-width: calc(100% - 20px); /* Adjust width for mobile */
            max-height: 120px; /* Slightly shorter on mobile */
        }
        .live-feed-item {
            font-size: 12px; /* Smaller font on mobile */
        }
    }
    @media screen and (max-width: 480px) {
        #live-feed-display {
           bottom: 190px; /* May need further adjustment if control panel grows */
        }
    }
    /* --- END Live Feed Display Styles --- */

    /* --- Live Feed Setup Modal Styles --- */
    .live-feed-modal-content {
      width: 90%;
      max-width: 500px; /* Adjust width as needed */
      max-height: 85vh; /* Limit height */
      display: flex;
      flex-direction: column;
    }

    .live-feed-modal-content h2 {
      text-align: center;
      margin-bottom: 15px;
      text-shadow: 0 0 8px var(--primary-color);
    }

    #live-feed-search {
        width: 100%;
        padding: 8px 10px;
        background-color: #000;
        color: #00ff00;
        border: 1px solid #00ff00;
        border-radius: 4px;
        font-family: 'Share Tech Mono', monospace;
        font-size: 14px;
        box-sizing: border-box;
        margin-bottom: 15px;
    }

    .live-feed-master-controls {
        display: flex;
        justify-content: space-around;
        padding: 10px 0;
        margin-bottom: 15px;
        border-top: 1px solid rgba(0, 255, 0, 0.2);
        border-bottom: 1px solid rgba(0, 255, 0, 0.2);
    }

    .live-feed-master-controls label {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        font-size: 14px;
        color: var(--text-color);
    }

    .live-feed-master-controls input[type="checkbox"] {
        margin-right: 8px;
        accent-color: var(--primary-color);
        width: 16px;
        height: 16px;
    }

    #live-feed-talkgroup-list {
      flex-grow: 1; /* Allow list to take available space */
      overflow-y: auto; /* Enable scrolling */
      padding-right: 10px; /* Space for scrollbar */
      margin-bottom: 15px;
      border: 1px solid rgba(0, 255, 0, 0.2);
      padding: 5px;
      min-height: 200px; /* Ensure it has some height */
    }

    /* Scrollbar for talkgroup list */
    #live-feed-talkgroup-list::-webkit-scrollbar {
      width: 10px;
    }

    #live-feed-talkgroup-list::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
    }

    #live-feed-talkgroup-list::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 5px;
      border: 2px solid rgba(0, 0, 0, 0.3);
    }

    #live-feed-talkgroup-list {
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) rgba(0, 0, 0, 0.3);
    }

    .live-feed-tg-item {
      display: flex;
      align-items: center;
      padding: 8px 5px;
      margin-bottom: 3px;
      border-radius: 3px;
      transition: background-color 0.2s;
      cursor: pointer;
    }

    .live-feed-tg-item:hover {
        background-color: rgba(0, 51, 0, 0.2);
    }

    .live-feed-tg-item input[type="checkbox"] {
        margin-right: 10px;
        accent-color: var(--primary-color);
        flex-shrink: 0;
        width: 15px;
        height: 15px;
    }

    .live-feed-tg-item label {
        font-size: 14px;
        color: var(--text-color);
        flex-grow: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    /* --- END Live Feed Setup Modal Styles --- */

    /* Google Places Autocomplete Styling */
    .pac-container {
      background-color: #000 !important;
      border: 1px solid #00ff00 !important;
      border-radius: 4px !important;
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.3) !important;
      font-family: 'Share Tech Mono', monospace !important;
    }

    .pac-item {
      background-color: #000 !important;
      color: #00ff00 !important;
      border: none !important;
      padding: 8px 12px !important;
      cursor: pointer !important;
    }

    .pac-item:hover {
      background-color: rgba(0, 255, 0, 0.1) !important;
    }

    .pac-item-selected {
      background-color: rgba(0, 255, 0, 0.2) !important;
    }

    .pac-item-query {
      color: #00ff00 !important;
      font-weight: bold !important;
    }

    .pac-matched {
      color: #00ccff !important;
    }

    .pac-icon {
      filter: invert(1) hue-rotate(120deg) brightness(1.5) !important;
    }
  </style>
</head>

<body>
  <button id="sidebar-toggle-btn" aria-label="Toggle Category Sidebar">‚ò∞ Categories</button>
  <div id="map"></div>

  <div id="category-sidebar">
    <div class="category-header">Categories</div>
    <div id="category-list"></div>
  </div>

  <div id="control-panel">
     <div class="left-controls">
      <select id="time-filter">
        <option value="1">Last 1 hour</option>
        <option value="3">Last 3 hours</option>
        <option value="6">Last 6 hours</option>
        <option value="12" selected>Last 12 hours</option>
        <option value="24">Last 24 hours</option>
        <option value="48">Last 2 days</option>
        <option value="168">Last 7 days</option>
        <option value="custom">Custom range</option>
      </select>
      <button id="toggle-mode">Day/Night</button>
      <button id="live-feed-setup-btn">Live Feed</button>
      </div>

    <div id="new-call-banner" class="hidden">
      New call from: <span id="talkgroup-name"></span><span class="ellipsis"></span>
    </div>

    <div class="center-controls">
      <div class="search-heatmap-container">
        <input type="text" id="search-input" placeholder="Search Calls..." />
        <div class="heatmap-controls">
          <label for="enable-heatmap">
            <input type="checkbox" id="enable-heatmap" />
            Enable Heatmap
          </label>
          <div id="heatmap-intensity-container">
            <input type="range" id="heatmap-intensity" min="1" max="10" value="5" />
          </div>
          <div id="global-volume-container" class="global-volume-controls">
            <label for="global-volume">Volume:</label>
            <input type="range" id="global-volume" class="volume" min="0" max="1" step="0.05" value="0.5" />
          </div>
        </div>
      </div>
    </div>

    <div class="right-controls">
      <div class="controls-checkbox-group">
        <label for="mute-new-calls">
          <input type="checkbox" id="mute-new-calls" />
          Mute New Calls
        </label>
        <label for="track-new-calls">
          <input type="checkbox" id="track-new-calls" checked />
          Track New Calls
        </label>
      </div>
      <div class="user-management-dropdown">
        <button id="user-menu-btn" class="cyberpunk-button">Settings</button>
        <div id="user-menu-content" class="dropdown-content">
          <a href="#" id="quick-start-btn">Quick Start</a>
          <a href="#" id="add-user-btn">Add User</a>
          <a href="#" id="view-users-btn">View Users</a>
          <a href="#" id="manage-sessions-btn">Manage Sessions</a>
          <a href="#" id="service-config-btn">Service Configuration</a>
          <a href="#" id="call-purge-btn">Call Purge</a>
        </div>
      </div>
    </div>
     </div>

  <div id="summary-bar">
    <div class="ticker-wrap"><div class="ticker"></div></div>
  </div>
<div id="custom-time-modal" class="modal">
    <div class="modal-content">
      <h2>Select Custom Time Range</h2>
      <div class="form-group"><label>Start Date:</label><input type="date" id="custom-start-date" /></div>
      <div class="form-group"><label>Start Time:</label><input type="time" id="custom-start-time" /></div>
      <div class="form-group"><label>End Date:</label><input type="date" id="custom-end-date" /></div>
      <div class="form-group"><label>End Time:</label><input type="time" id="custom-end-time" /></div>
      <div class="modal-buttons">
        <button onclick="applyCustomTimeFilter()" class="confirm-btn">Apply</button>
        <button type="button" class="cancel-btn" onclick="document.getElementById('custom-time-modal').style.display='none'">Cancel</button>
      </div>
    </div>
  </div>

  <div id="add-user-modal" class="modal">
    <div class="modal-content">
      <h2>Add New User</h2>
      <form id="add-user-form">
        <div class="form-group"><label>Username:</label><input type="text" id="new-username" required /></div>
        <div class="form-group"><label>Password:</label><input type="password" id="new-password" required /></div>
        <div class="modal-buttons">
          <button type="submit" class="confirm-btn">Add User</button>
          <button type="button" class="cancel-btn" onclick="document.getElementById('add-user-modal').style.display='none'">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="view-users-modal" class="modal">
    <div class="modal-content">
      <h2>Manage Users</h2>
      <div id="users-list" class="users-list">Loading...</div>
      <div class="modal-buttons">
          <button type="button" class="cancel-btn" onclick="document.getElementById('view-users-modal').style.display='none'">Close</button>
        </div>
    </div>
  </div>

  <div id="sessions-modal" class="modal">
    <div class="modal-content">
      <h2>Active Sessions</h2>
      <div class="user-selection">
        <label for="user-dropdown">Select User:</label>
        <select id="user-dropdown" class="styled-select"></select>
      </div>
      <div id="sessions-list" class="sessions-list">Loading...</div>
      <div class="modal-buttons">
          <button type="button" class="cancel-btn" onclick="document.getElementById('sessions-modal').style.display='none'">Close</button>
        </div>
    </div>
  </div>

  <!-- Call Purge Modal -->
  <div id="call-purge-modal" class="modal">
    <div class="modal-content call-purge-modal-content">
      <h2>Call Purge</h2>
      <p class="purge-description">Remove calls from the map while preserving all call information. Selected calls will no longer appear on the map but remain in the database.</p>
      
      <div class="form-group">
        <label for="purge-talkgroup-search">Search Talkgroups:</label>
        <input type="text" id="purge-talkgroup-search" placeholder="Start typing..." />
      </div>
      
      <div id="purge-talkgroup-list" class="purge-talkgroup-list">
        <div class="loading-placeholder">Loading talkgroups...</div>
      </div>
      
      <div class="form-group">
        <label for="purge-category-select">Category:</label>
        <select id="purge-category-select" class="styled-select">
          <option value="">All Categories</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Time Range:</label>
        <div class="time-range-options">
          <button type="button" class="time-preset-btn" data-hours="1">Last 1 hour</button>
          <button type="button" class="time-preset-btn" data-hours="3">Last 3 hours</button>
          <button type="button" class="time-preset-btn" data-hours="6">Last 6 hours</button>
          <button type="button" class="time-preset-btn" data-hours="12">Last 12 hours</button>
          <button type="button" class="time-preset-btn" data-hours="24">Last 24 hours</button>
          <button type="button" class="time-preset-btn" data-hours="48">Last 2 days</button>
          <button type="button" class="time-preset-btn" data-hours="168">Last 7 days</button>
        </div>
        <div class="custom-time-section">
          <label for="purge-custom-time-toggle">
            <input type="checkbox" id="purge-custom-time-toggle" />
            Custom Time Range
          </label>
          <div id="purge-custom-time-inputs" class="custom-time-inputs" style="display: none;">
            <div class="time-input-row">
              <div class="time-input-group">
                <label for="purge-start-date">Start Date:</label>
                <input type="date" id="purge-start-date" />
              </div>
              <div class="time-input-group">
                <label for="purge-start-time">Start Time:</label>
                <input type="time" id="purge-start-time" />
              </div>
            </div>
            <div class="time-input-row">
              <div class="time-input-group">
                <label for="purge-end-date">End Date:</label>
                <input type="date" id="purge-end-date" />
              </div>
              <div class="time-input-group">
                <label for="purge-end-time">End Time:</label>
                <input type="time" id="purge-end-time" />
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-buttons">
        <button type="button" id="purge-confirm-btn" class="confirm-btn">Purge Calls</button>
        <button type="button" id="undo-last-purge-btn" class="undo-btn" style="display: none;">Undo Last Purge</button>
        <button type="button" class="cancel-btn" onclick="document.getElementById('call-purge-modal').style.display='none'">Cancel</button>
      </div>
    </div>
  </div>
  <!-- END Call Purge Modal -->
  
  <!-- Call Purge Confirmation Modal -->
  <div id="purge-confirmation-modal" class="modal">
    <div class="modal-content confirmation-modal-content">
      <h2>Confirm Call Purge</h2>
      <div id="purge-confirmation-message" class="confirmation-message">
        <!-- Message will be populated by JavaScript -->
      </div>
      <div class="modal-buttons">
        <button type="button" id="purge-confirm-yes" class="confirm-btn">Yes, Purge Calls</button>
        <button type="button" id="purge-confirm-no" class="cancel-btn">Cancel</button>
      </div>
    </div>
  </div>
  <!-- END Call Purge Confirmation Modal -->
  
  <div id="audio-container" style="display: none;"></div>

  <!-- Talkgroup History Modal -->
  <div id="talkgroup-modal" class="modal">
    <div class="modal-content talkgroup-modal-content">
      <h2 id="talkgroup-modal-title">Talkgroup History</h2>

      <!-- Autoplay Toggle -->
      <div class="talkgroup-modal-controls">
        <label for="talkgroup-autoplay-toggle" id="talkgroup-autoplay-label">
          <input type="checkbox" id="talkgroup-autoplay-toggle" />
          <span>Autoplay New Calls</span>
        </label>
      </div>
      <!-- End Autoplay Toggle -->

      <div id="talkgroup-list" class="talkgroup-list">
        <!-- Transcription items will be loaded here -->
        <div class="loading-placeholder">Loading history...</div>
      </div>
      <div class="modal-buttons">
        <button type="button" class="cancel-btn" onclick="closeTalkgroupModal()">Close</button>
      </div>
    </div>
  </div>
  <!-- END Talkgroup History Modal -->

  <!-- NEW: Live Feed Setup Modal -->
  <div id="live-feed-modal" class="modal">
      <div class="modal-content live-feed-modal-content">
          <h2>Live Feed Setup</h2>

          <div class="form-group">
              <label for="live-feed-search">Search Talkgroups:</label>
              <input type="text" id="live-feed-search" placeholder="Start typing..." />
          </div>

          <div class="live-feed-master-controls">
              <!-- REMOVED AUDIO ENABLE CHECKBOX -->
              <!--
              <label>
                  <input type="checkbox" id="live-feed-audio-enable" />
                  Enable Live Audio
              </label>
              -->
          </div>

          <div id="live-feed-talkgroup-list">
              <div class="loading-placeholder">Loading talkgroups...</div>
          </div>

          <div class="modal-buttons">
              <button type="button" class="cancel-btn" onclick="closeLiveFeedModal()">Close</button>
          </div>
      </div>
  </div>
  <!-- END Live Feed Setup Modal -->

  <!-- NEW: Live Feed Display Area -->
  <div id="live-feed-display">
  </div>
  <!-- END Live Feed Display Area -->

  <!-- Service Configuration Modal -->
  <div id="service-config-modal" class="modal">
    <div class="modal-content">
      <h2>Service Configuration</h2>
      <p class="config-description">Configure remote service URLs for Ollama and iCAD Transcribe. Leave empty to use local Docker containers.</p>
      
      <div class="form-group">
        <label for="ollama-url">Ollama URL:</label>
        <input type="text" id="ollama-url" placeholder="http://localhost:11434 or http://remote-server:11434" />
        <small>Leave empty to use local Docker container</small>
      </div>
      
      <div class="form-group">
        <label for="icad-url">iCAD Transcribe URL:</label>
        <input type="text" id="icad-url" placeholder="http://localhost:9912 or http://remote-server:9912" />
        <small>Leave empty to use local Docker container</small>
      </div>
      
      <div class="modal-buttons">
        <button type="button" id="save-service-config-btn" class="confirm-btn">Save Configuration</button>
        <button type="button" class="cancel-btn" onclick="document.getElementById('service-config-modal').style.display='none'">Cancel</button>
      </div>
    </div>
  </div>
  <!-- END Service Configuration Modal -->

  <!-- Quick Start Modal -->
  <div id="quick-start-modal" class="modal">
    <div class="modal-content quick-start-modal-content">
      <h2>Quick Start</h2>
      <div class="quick-start-tabs">
        <button class="quick-start-tab active" data-tab="location">Location</button>
        <button class="quick-start-tab" data-tab="system">System Status</button>
        <button class="quick-start-tab" data-tab="updates">Updates</button>
        <button class="quick-start-tab" data-tab="radio">Radio Config</button>
        <button class="quick-start-tab" data-tab="ai-commands">AI Commands</button>
      </div>
      
      <!-- Location Tab -->
      <div id="quick-start-location-tab" class="quick-start-tab-content active">
        <h3>Location Configuration</h3>
        <p class="config-description">Configure your location for accurate geocoding of radio calls.</p>
        
        <div class="form-group">
          <button type="button" id="detect-location-btn" class="confirm-btn">Detect My Location</button>
          <span id="location-detect-status"></span>
        </div>
        
        <div id="location-map-container" style="height: 300px; margin: 15px 0; display: none;"></div>
        
        <div class="form-group">
          <label for="geocoding-city">City:</label>
          <input type="text" id="geocoding-city" placeholder="e.g., Baltimore" />
        </div>
        
        <div class="form-group">
          <label for="geocoding-state">State/Province:</label>
          <input type="text" id="geocoding-state" placeholder="e.g., MD" />
        </div>
        
        <div class="form-group">
          <label for="geocoding-country">Country:</label>
          <input type="text" id="geocoding-country" placeholder="e.g., us" />
        </div>
        
        <div class="form-group">
          <label for="geocoding-counties">Target Counties (comma-separated):</label>
          <input type="text" id="geocoding-counties" placeholder="e.g., Baltimore, Baltimore City, Anne Arundel" />
        </div>
        
        <div id="location-suggestions" style="margin: 15px 0;"></div>
        
        <div class="modal-buttons">
          <button type="button" id="save-location-btn" class="confirm-btn">Save Location</button>
        </div>
      </div>
      
      <!-- System Status Tab -->
      <div id="quick-start-system-tab" class="quick-start-tab-content">
        <h3>System Status</h3>
        <p class="config-description">Check system requirements and dependencies.</p>
        
        <div id="system-status-list">
          <div class="system-status-item">
            <span class="system-status-name">Docker</span>
            <span class="system-status-icon" id="docker-status">‚è≥ Checking...</span>
            <button type="button" id="install-docker-btn" class="install-btn" style="display: none;" disabled>Install</button>
          </div>
          <div class="system-status-item">
            <span class="system-status-name">Node.js</span>
            <span class="system-status-icon" id="nodejs-status">‚è≥ Checking...</span>
            <button type="button" id="install-nodejs-btn" class="install-btn" style="display: none;" disabled>Install</button>
          </div>
          <div class="system-status-item">
            <span class="system-status-name">Python</span>
            <span class="system-status-icon" id="python-status">‚è≥ Checking...</span>
            <button type="button" id="install-python-btn" class="install-btn" style="display: none;" disabled>Install</button>
          </div>
        </div>
        
        <div id="system-info" style="margin-top: 20px;">
          <h4>System Information</h4>
          <div id="system-info-content">Loading...</div>
        </div>
        
        <div id="gpu-config" style="margin-top: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px;">
          <h4>GPU Configuration (Docker only)</h4>
          <div id="gpu-status-display">
            <div>Status: <span id="gpu-status-text">Loading...</span></div>
            <div id="gpu-name" style="margin-top: 10px;"></div>
            <div style="margin-top: 10px;">
              <label>
                <input type="checkbox" id="gpu-enabled-checkbox" />
                Enable GPU acceleration
              </label>
            </div>
            <div id="nvidia-toolkit-section" style="margin-top: 10px; display: none;">
              <button type="button" id="install-nvidia-toolkit-btn" class="install-btn">Install NVIDIA Container Toolkit</button>
            </div>
          </div>
        </div>
        
        <div id="autostart-config" style="margin-top: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px;">
          <h4>Auto-Start Configuration</h4>
          <div id="autostart-status-display">
            <div>Status: <span id="autostart-status-text">Loading...</span></div>
            <div style="margin-top: 10px;">
              <label>
                <input type="checkbox" id="autostart-enabled-checkbox" />
                Start Scanner Map automatically on system boot
              </label>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Updates Tab -->
      <div id="quick-start-updates-tab" class="quick-start-tab-content">
        <h3>Update Scanner Map</h3>
        <p class="config-description">Check for updates and configure auto-update.</p>
        
        <div id="update-status">
          <div class="update-info-item">
            <span>Current Version:</span>
            <span id="current-version">Loading...</span>
          </div>
          <div class="update-info-item">
            <span>Latest Version:</span>
            <span id="latest-version">Loading...</span>
          </div>
          <div id="update-available-badge" style="display: none; margin: 10px 0; padding: 10px; background-color: #00ff00; color: #000; border-radius: 4px;">
            Update Available!
          </div>
        </div>
        
        <div class="modal-buttons" style="margin-top: 20px;">
          <button type="button" id="check-updates-btn" class="confirm-btn">Check for Updates</button>
          <button type="button" id="install-update-btn" class="confirm-btn" style="display: none;">Install Update</button>
        </div>
        
        <div class="form-group" style="margin-top: 20px;">
          <label>
            <input type="checkbox" id="auto-update-checkbox" />
            Enable auto-update (checks on startup)
          </label>
        </div>
      </div>
      
      <!-- Radio Config Tab -->
      <div id="quick-start-radio-tab" class="quick-start-tab-content">
        <h3>Radio Configuration</h3>
        <p class="config-description">Manage talkgroups and frequencies.</p>
        
        <div class="quick-start-radio-subtabs">
          <button class="quick-start-subtab active" data-subtab="talkgroups">Talkgroups</button>
          <button class="quick-start-subtab" data-subtab="frequencies">Frequencies</button>
          <button class="quick-start-subtab" data-subtab="software-config">Auto-Config</button>
        </div>
        
        <!-- Talkgroups Sub-tab -->
        <div id="radio-talkgroups-subtab" class="quick-start-subtab-content active">
          <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button type="button" id="add-talkgroup-btn" class="confirm-btn">Add Talkgroup</button>
            <button type="button" id="import-talkgroups-csv-btn" class="confirm-btn">Import CSV</button>
          </div>
          
          <!-- CSV Import Section (hidden by default) -->
          <div id="talkgroups-csv-import-section" style="display: none; margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px;">
            <h4>Import Talkgroups from CSV</h4>
            <div class="form-group">
              <label for="talkgroups-csv-file">Select CSV file:</label>
              <input type="file" id="talkgroups-csv-file" accept=".csv" style="margin-top: 5px;" />
              <div style="margin-top: 10px; padding: 10px; border: 2px dashed var(--border-color); border-radius: 4px; text-align: center; cursor: pointer;" id="talkgroups-csv-drop-zone">
                <p>Drag and drop CSV file here, or click to select</p>
              </div>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="talkgroups-csv-merge" />
                Merge/Update existing entries (if unchecked, will only add new entries)
              </label>
            </div>
            <div id="talkgroups-csv-preview" style="margin-top: 15px; display: none;">
              <h5>Preview (first 10 rows):</h5>
              <div id="talkgroups-csv-preview-content" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px;"></div>
              <div id="talkgroups-csv-preview-errors" style="margin-top: 10px; color: #ff0000;"></div>
              <div style="margin-top: 10px;">
                <button type="button" id="talkgroups-csv-import-btn" class="confirm-btn">Import CSV</button>
                <button type="button" id="talkgroups-csv-cancel-btn" class="cancel-btn">Cancel</button>
              </div>
            </div>
            <div id="talkgroups-csv-progress" style="display: none; margin-top: 15px;">
              <div>Importing...</div>
              <div id="talkgroups-csv-progress-bar" style="width: 100%; height: 20px; background-color: rgba(0, 255, 0, 0.2); border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden;">
                <div id="talkgroups-csv-progress-fill" style="height: 100%; background-color: var(--primary-color); width: 0%; transition: width 0.3s;"></div>
              </div>
            </div>
            <div id="talkgroups-csv-results" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
          </div>
          <div id="talkgroups-list-container">
            <table id="talkgroups-table" style="width: 100%; margin-top: 15px;">
              <thead>
                <tr>
                  <th>DEC</th>
                  <th>HEX</th>
                  <th>Alpha Tag</th>
                  <th>Mode</th>
                  <th>Description</th>
                  <th>Tag</th>
                  <th>County</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="talkgroups-table-body">
                <tr><td colspan="8">Loading...</td></tr>
              </tbody>
            </table>
          </div>
          
          <!-- Talkgroup Edit Form (hidden by default) -->
          <div id="talkgroup-edit-form" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px;">
            <h4 id="talkgroup-form-title">Add Talkgroup</h4>
            <div class="form-group">
              <label for="talkgroup-dec">DEC (required):</label>
              <input type="number" id="talkgroup-dec" required />
            </div>
            <div class="form-group">
              <label for="talkgroup-hex">HEX:</label>
              <input type="text" id="talkgroup-hex" />
            </div>
            <div class="form-group">
              <label for="talkgroup-alpha-tag">Alpha Tag:</label>
              <input type="text" id="talkgroup-alpha-tag" />
            </div>
            <div class="form-group">
              <label for="talkgroup-mode">Mode:</label>
              <input type="text" id="talkgroup-mode" />
            </div>
            <div class="form-group">
              <label for="talkgroup-description">Description:</label>
              <input type="text" id="talkgroup-description" />
            </div>
            <div class="form-group">
              <label for="talkgroup-tag">Tag:</label>
              <input type="text" id="talkgroup-tag" />
            </div>
            <div class="form-group">
              <label for="talkgroup-county">County:</label>
              <input type="text" id="talkgroup-county" />
            </div>
            <div class="modal-buttons">
              <button type="button" id="save-talkgroup-btn" class="confirm-btn">Save</button>
              <button type="button" id="cancel-talkgroup-btn" class="cancel-btn">Cancel</button>
            </div>
          </div>
        </div>
        
        <!-- Frequencies Sub-tab -->
        <div id="radio-frequencies-subtab" class="quick-start-subtab-content">
          <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button type="button" id="add-frequency-btn" class="confirm-btn">Add Frequency</button>
            <button type="button" id="import-frequencies-csv-btn" class="confirm-btn">Import CSV</button>
          </div>
          
          <!-- CSV Import Section (hidden by default) -->
          <div id="frequencies-csv-import-section" style="display: none; margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px;">
            <h4>Import Frequencies from CSV</h4>
            <div class="form-group">
              <label for="frequencies-csv-file">Select CSV file:</label>
              <input type="file" id="frequencies-csv-file" accept=".csv" style="margin-top: 5px;" />
              <div style="margin-top: 10px; padding: 10px; border: 2px dashed var(--border-color); border-radius: 4px; text-align: center; cursor: pointer;" id="frequencies-csv-drop-zone">
                <p>Drag and drop CSV file here, or click to select</p>
              </div>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="frequencies-csv-merge" />
                Merge/Update existing entries (if unchecked, will only add new entries)
              </label>
            </div>
            <div id="frequencies-csv-preview" style="margin-top: 15px; display: none;">
              <h5>Preview (first 10 rows):</h5>
              <div id="frequencies-csv-preview-content" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px;"></div>
              <div id="frequencies-csv-preview-errors" style="margin-top: 10px; color: #ff0000;"></div>
              <div style="margin-top: 10px;">
                <button type="button" id="frequencies-csv-import-btn" class="confirm-btn">Import CSV</button>
                <button type="button" id="frequencies-csv-cancel-btn" class="cancel-btn">Cancel</button>
              </div>
            </div>
            <div id="frequencies-csv-progress" style="display: none; margin-top: 15px;">
              <div>Importing...</div>
              <div id="frequencies-csv-progress-bar" style="width: 100%; height: 20px; background-color: rgba(0, 255, 0, 0.2); border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden;">
                <div id="frequencies-csv-progress-fill" style="height: 100%; background-color: var(--primary-color); width: 0%; transition: width 0.3s;"></div>
              </div>
            </div>
            <div id="frequencies-csv-results" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
          </div>
          <div id="frequencies-list-container">
            <table id="frequencies-table" style="width: 100%; margin-top: 15px;">
              <thead>
                <tr>
                  <th>Site ID</th>
                  <th>Frequency (MHz)</th>
                  <th>Description</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="frequencies-table-body">
                <tr><td colspan="4">Loading...</td></tr>
              </tbody>
            </table>
          </div>
          
          <!-- Frequency Edit Form (hidden by default) -->
          <div id="frequency-edit-form" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px;">
            <h4 id="frequency-form-title">Add Frequency</h4>
            <div class="form-group">
              <label for="frequency-site-id">Site ID:</label>
              <input type="number" id="frequency-site-id" />
            </div>
            <div class="form-group">
              <label for="frequency-value">Frequency (MHz) (required):</label>
              <input type="number" id="frequency-value" step="0.0001" required />
            </div>
            <div class="form-group">
              <label for="frequency-description">Description:</label>
              <input type="text" id="frequency-description" />
            </div>
            <div class="modal-buttons">
              <button type="button" id="save-frequency-btn" class="confirm-btn">Save</button>
              <button type="button" id="cancel-frequency-btn" class="cancel-btn">Cancel</button>
            </div>
          </div>
        </div>
        
        <!-- Radio Software Auto-Config Sub-tab -->
        <div id="radio-software-config-subtab" class="quick-start-subtab-content">
          <h4>Radio Software Auto-Configuration</h4>
          <p>Automatically configure TrunkRecorder from your frequencies and talkgroups.</p>
          
          <div id="radio-software-status" style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px;">
            <h5>Detection Status</h5>
            <div id="radio-software-status-content">Loading...</div>
          </div>
          
          <div class="form-group" style="margin-bottom: 20px;">
            <button type="button" id="detect-radio-software-btn" class="confirm-btn">Detect Radio Software</button>
            <button type="button" id="configure-trunkrecorder-btn" class="confirm-btn" style="display: none;">Configure TrunkRecorder</button>
          </div>
          
          <div id="trunkrecorder-config-preview" style="display: none; margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px;">
            <h5>Configuration Preview</h5>
            <div id="trunkrecorder-config-preview-content" style="max-height: 300px; overflow-y: auto; background-color: rgba(0, 0, 0, 0.5); padding: 10px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word;"></div>
            <div style="margin-top: 15px;">
              <button type="button" id="trunkrecorder-config-save-btn" class="confirm-btn">Save Configuration</button>
              <button type="button" id="trunkrecorder-config-cancel-btn" class="cancel-btn">Cancel</button>
            </div>
          </div>
          
          <div id="trunkrecorder-config-results" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
        </div>
      </div>
      
      <!-- AI Commands Tab -->
      <div id="quick-start-ai-commands-tab" class="quick-start-tab-content">
        <h3>AI Commands</h3>
        <p class="config-description">Configure radio settings using natural language commands.</p>
        
        <!-- Command Examples -->
        <div class="form-group" style="margin-bottom: 20px;">
          <h4>Example Commands</h4>
          <div id="command-examples-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin-top: 10px;">
            <!-- Examples will be loaded here -->
          </div>
        </div>
        
        <!-- Command Input -->
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="ai-command-input">Enter Command:</label>
          <div style="display: flex; gap: 10px; margin-top: 5px;">
            <input type="text" id="ai-command-input" placeholder="e.g., Add talkgroup 1234 for Fire Department" style="flex: 1; padding: 10px;" />
            <button type="button" id="ai-command-submit-btn" class="confirm-btn">Send</button>
            <button type="button" id="ai-command-voice-btn" class="confirm-btn" title="Voice Input">üé§</button>
          </div>
        </div>
        
        <!-- Command History -->
        <div class="form-group" style="margin-bottom: 20px;">
          <h4>Command History</h4>
          <div id="ai-command-history" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; background-color: rgba(0, 0, 0, 0.3); border-radius: 4px;">
            <div style="color: #888; font-style: italic;">No commands yet. Try entering a command above.</div>
          </div>
        </div>
        
        <!-- Parsing Results (shown when command is being parsed) -->
        <div id="ai-command-parsing" style="display: none; margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px;">
          <h5>Parsing Command...</h5>
          <div id="ai-command-parsing-result"></div>
        </div>
        
        <!-- Voice Input Feedback -->
        <div id="ai-voice-feedback" style="display: none; margin-bottom: 20px; padding: 15px; border: 2px solid var(--primary-color); border-radius: 4px; text-align: center;">
          <div style="font-size: 24px; margin-bottom: 10px;">üé§</div>
          <div>Listening...</div>
          <div id="ai-voice-status" style="margin-top: 10px; color: #888; font-size: 12px;"></div>
        </div>
      </div>
      
      <div class="modal-buttons" style="margin-top: 20px;">
        <button type="button" class="cancel-btn" onclick="closeQuickStartModal()">Close</button>
      </div>
    </div>
  </div>
  <!-- END Quick Start Modal -->

  <script src="config.js"></script>
  <script src="utils.js"></script>
  <script src="memory.js"></script>
  <script src="errors.js"></script>
  <script src="toast.js"></script>
  <script src="gestures.js"></script>
  <script src="map.js"></script>
  <script src="audio.js"></script>
  <script src="modals.js"></script>
  <script src="api.js"></script>
  <script src="ui.js"></script>
  <script src="app.js" defer></script>

  <script>
    // Function to initialize Google Maps
    async function initGoogleMaps() {
      // Wait for the API key to be fetched
      await new Promise((resolve) => {
        const checkKey = () => {
          if (window?.appConfig?.geocoding?.googleApiKey) {
            resolve();
          } else {
            setTimeout(checkKey, 100);
          }
        };
        checkKey();
      });

      const gKey = window.appConfig.geocoding.googleApiKey;
      if (gKey) {
        return new Promise((resolve) => {
          const gScript = document.createElement('script');
          gScript.src = `https://maps.googleapis.com/maps/api/js?key=${gKey}&libraries=places&callback=onGoogleMapsLoaded`;
          gScript.async = true;
          gScript.defer = true;
          window.onGoogleMapsLoaded = () => {
              console.log('Google Maps API loaded successfully');
              resolve();
          };
          document.head.appendChild(gScript);
        });
      } else {
        console.error('Google Maps API key is missing from config.js (appConfig.geocoding.googleApiKey)');
        return Promise.reject('No API key');
      }
    }

    // Start Google Maps loading
    initGoogleMaps().catch(error => {
        console.error('Failed to initialize Google Maps API:', error);
        // Application can potentially continue without maps features, or show an error
    });

    // Placeholder function to close the new modal (will be defined in app.js)
    function closeLiveFeedModal() {
      const modal = document.getElementById('live-feed-modal');
      if (modal) {
          modal.style.display = 'none';
      }
    }
    
    // Placeholder function to close Quick Start modal (will be defined in app.js)
    function closeQuickStartModal() {
      const modal = document.getElementById('quick-start-modal');
      if (modal) {
          modal.style.display = 'none';
      }
    }
  </script>
</body>
</html>
