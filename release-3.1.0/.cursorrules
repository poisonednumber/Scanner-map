# Scanner-Map Project Rules

## Project Overview
Scanner-Map is a real-time radio call mapping system with AI transcription, geocoding, and Discord bot integration. It processes audio from SDRTrunk/TrunkRecorder, transcribes it, extracts addresses, and displays calls on a web map.

## Architecture
- **bot.js**: Main entry point - orchestrates everything, handles Discord, processes audio uploads
- **webserver.js**: Express server for the web UI and API endpoints
- **geocoding.js**: Address extraction and geocoding (Google/LocationIQ)
- **transcribe.py**: Python Whisper-based audio transcription
- **tone_detect.py**: Two-tone pager detection
- **public/**: Frontend (vanilla JS, no framework)
- **scripts/installer/**: Cross-platform Node.js installer modules

## Code Style & Conventions

### JavaScript/Node.js
- Use ES6+ features (async/await, arrow functions, destructuring)
- Use `require()` for imports (CommonJS - not ES modules)
- Use `node-fetch@2` (v2.x) for fetch - not native fetch
- Error handling: wrap async operations in try/catch
- Logging: use winston logger when available, console.log for simple scripts
- Database: SQLite3 with callback-style API

### Python
- Use Python 3.10+
- Follow PEP 8 style
- Use python-dotenv for environment variables
- Virtual environment expected at `.venv/`

### Environment Variables
- All config goes in `.env` file
- Never hardcode API keys, tokens, or secrets
- Reference `.env.example` for available options

## File Patterns to NEVER Create
- Don't create files in: `node_modules/`, `data/`, `audio/`, `logs/`
- Don't create: `.env` (user must create from template)
- Don't create: `apikeys.json` (auto-generated at runtime)
- Don't create test files unless explicitly asked

## File Patterns to NEVER Commit
- `.env` and any `.env.*` files (except `.env.example`)
- `data/` folder contents (runtime data)
- `audio/` folder contents (user recordings)
- `*.db` database files
- `logs/` and `*.log` files
- `apikeys.json`

## Development Workflow
1. Installer entry points: `install.bat` (Windows) or `install.sh` (Linux/Mac)
2. These call `scripts/installer/installer-core.js` for the interactive setup
3. Main app runs via `node bot.js` (starts everything)
4. For development, can run `webserver.js` separately

## Testing Locally
- Create `.env` from template
- Run `npm install`
- For Python: create venv, install from `requirements.txt`
- Run `node bot.js` to start all services

## ⚠️ CRITICAL RULE: Auto-Integration of New Features

**Whenever ANYTHING is added to the project that requires dependencies or configuration, it MUST be automatically integrated into the installer and startup process.**

### Required Steps for New Additions:

#### 1. New npm Package
- ✅ Add to `package.json` dependencies
- ✅ **MUST** update installer to auto-install if missing
- ✅ Add to `dependency-installer.js` if it's a system-level dependency
- ✅ Update `.env.example` if it needs configuration
- ✅ Update `env-generator.js` if it needs user input

#### 2. New Python Package
- ✅ Add to `requirements.txt`
- ✅ **MUST** update installer to auto-install if missing
- ✅ Add Python installation check to `dependency-installer.js`
- ✅ Update `.env.example` if it needs configuration
- ✅ Update `env-generator.js` if it needs user input

#### 3. New Environment Variable
- ✅ Add to `.env.example` with full documentation
- ✅ **MUST** add to `scripts/installer/env-generator.js` with:
  - Default value
  - User prompt (if needed)
  - Auto-configuration (if possible)
- ✅ Add validation in relevant module (bot.js, webserver.js, etc.)
- ✅ Update documentation in `docs/CONFIGURATION.md`

#### 4. New Service/Integration
- ✅ **MUST** add to installer flow (`installer-core.js`)
- ✅ **MUST** add service configuration (`service-config.js`)
- ✅ **MUST** add Docker support (`docker-compose-builder.js`) if applicable
- ✅ **MUST** add auto-configuration of URLs/ports
- ✅ **MUST** add API key generation if needed
- ✅ Update `.env.example`
- ✅ Update `env-generator.js`
- ✅ Add to documentation

#### 5. New Docker Service
- ✅ **MUST** add to `docker-compose-builder.js`
- ✅ **MUST** add service detection/installation to `dependency-installer.js`
- ✅ **MUST** add auto-configuration of URLs and ports
- ✅ **MUST** add to installer flow
- ✅ Update documentation

#### 6. New Optional Feature
- ✅ **MUST** add as optional step in installer
- ✅ **MUST** have sensible defaults (disabled by default)
- ✅ **MUST** auto-configure if enabled
- ✅ Update `.env.example` with commented-out options

### Checklist Before Committing New Features:
- [ ] All dependencies added to package.json/requirements.txt
- [ ] Installer updated to handle new dependencies
- [ ] Environment variables added to .env.example
- [ ] env-generator.js updated with prompts/defaults
- [ ] Service auto-configuration added (if applicable)
- [ ] Docker support added (if applicable)
- [ ] Documentation updated
- [ ] Defaults are sensible and auto-configured where possible

## Common Tasks

### Adding new environment variables
1. Add to `.env.example` with documentation
2. **MUST** update `scripts/installer/env-generator.js` to:
   - Include in generated .env
   - Prompt user if needed
   - Auto-configure if possible
3. Add handling in relevant module (bot.js, webserver.js, etc.)
4. Update `docs/CONFIGURATION.md`

### Modifying the installer
- Core logic: `scripts/installer/installer-core.js`
- Docker setup: `scripts/installer/docker-installer.js`
- Local setup: `scripts/installer/local-installer.js`
- Environment config: `scripts/installer/env-generator.js`
- Service config: `scripts/installer/service-config.js`
- Dependency install: `scripts/installer/dependency-installer.js`
- GPU detection: `scripts/installer/gpu-detector.js`
- Docker Compose: `scripts/installer/docker-compose-builder.js`

### Frontend changes
- Main app: `public/app.js`
- Config: `public/config.js`
- Styles: `public/styles.css`
- Entry: `public/index.html`

