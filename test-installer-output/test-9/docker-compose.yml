# Docker Compose configuration for Scanner Map
# Generated by installer on 2025-12-19T15:11:01.818Z
# 
# Services enabled:
# - Ollama (Local AI) - Models stored in ./appdata/ollama/
# - iCAD Transcribe (Advanced Transcription) - Models stored in ./appdata/icad-transcribe/models/
# - TrunkRecorder (Radio Recording) - Pull image: docker pull robotastic/trunk-recorder:latest



# - GPU acceleration enabled (NVIDIA)
#
# Data Persistence:
# All data is stored in ./appdata/ directory with proper volume mounts:
# - scanner-map/ - Database, audio files, logs
# - ollama/ - AI models (persistent)
# - icad-transcribe/ - Models, config, database (all persistent)
# - trunk-recorder/ - Config and recordings



#
# To remove all data: rm -rf ./appdata
# To backup: Copy ./appdata directory
#
# Note: version field removed (obsolete in newer Docker Compose versions)

services:
  scanner-map:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TRANSCRIPTION_MODE: icad
    container_name: scanner-map
    restart: unless-stopped
    ports:
      - ${WEBSERVER_PORT:-3001}:3001
      - ${BOT_PORT:-3306}:3306
    volumes:
      - ./appdata/scanner-map/data:/app/data
      - ./appdata/scanner-map/audio:/app/audio
      - ./appdata/scanner-map/logs:/app/logs
      - ./.env:/app/.env
      - ./appdata/trunk-recorder/config:/app/appdata/trunk-recorder/config
      - ./appdata/icad-transcribe:/app/appdata/icad-transcribe
    environment:
      - NODE_ENV=production
    networks:
      - scanner-network
    healthcheck:
      test:
        - CMD
        - node
        - '-e'
        - 'require(''http'').get(''http://localhost:3001/api/test'', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})'
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - ollama
      - icad-transcribe
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    volumes:
      - ./appdata/ollama:/root/.ollama
    ports:
      - '11434:11434'
    networks:
      - scanner-network
    environment:
      - OLLAMA_KEEP_ALIVE=24h
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities:
                - gpu
  icad-transcribe:
    image: thegreatcodeholio/icad_transcribe:1.0
    container_name: icad-transcribe
    restart: unless-stopped
    user: '9911:9911'
    ports:
      - '9912:9912'
    volumes:
      - ./appdata/icad-transcribe/log:/app/log
      - ./appdata/icad-transcribe/var:/app/var
      - ./appdata/icad-transcribe/.env:/app/.env
      - ./appdata/icad-transcribe/models:/app/models
    networks:
      - scanner-network
    environment:
      - TZ=America/New_York
  trunk-recorder:
    image: robotastic/trunk-recorder:latest
    container_name: trunk-recorder
    restart: unless-stopped
    privileged: true
    devices:
      - /dev/bus/usb:/dev/bus/usb
    volumes:
      - ./appdata/trunk-recorder/config:/config
      - ./appdata/trunk-recorder/config/config.json:/app/config.json
      - ./appdata/trunk-recorder/recordings:/recordings
    environment:
      - TZ=America/New_York
    networks:
      - scanner-network
    pull_policy: missing
networks:
  scanner-network:
    driver: bridge
